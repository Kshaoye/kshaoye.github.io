import{_ as a,c as i,o as n,ag as t}from"./chunks/framework.z0p7P-Mv.js";const e="/img/k8s/buildProcedure.png",l="/img/k8s/imgBuildDiffrents.png",g=JSON.parse('{"title":"基于nerdctl+BuildKit+containerd构建容器镜像","description":"","frontmatter":{},"headers":[],"relativePath":"zh/k8s/BuildContainerImageWithNerdctlAndBuildKit.md","filePath":"zh/k8s/BuildContainerImageWithNerdctlAndBuildKit.md"}'),p={name:"zh/k8s/BuildContainerImageWithNerdctlAndBuildKit.md"};function h(r,s,d,k,o,c){return n(),i("div",null,[...s[0]||(s[0]=[t(`<h1 id="基于nerdctl-buildkit-containerd构建容器镜像" tabindex="-1">基于nerdctl+BuildKit+containerd构建容器镜像 <a class="header-anchor" href="#基于nerdctl-buildkit-containerd构建容器镜像" aria-label="Permalink to &quot;基于nerdctl+BuildKit+containerd构建容器镜像&quot;">​</a></h1><h2 id="_0-容器基础知识" tabindex="-1">0 容器基础知识 <a class="header-anchor" href="#_0-容器基础知识" aria-label="Permalink to &quot;0 容器基础知识&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">容器技术除docker之外，还有coreOS的rkt、google的gvisor、以及docker开源的containerd、redhat的podman、阿里的pouch等，为了保证容器生态的标准性和健康可持续发展，包括Docker、华为、微软、红帽、谷歌、AWS、IBM等公司在2015年6月共同成立了一个叫open</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> container（OCI，https://opencontainers.org/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ）的组织，其目的就是制定开放的标准的容器规范，目前OCI一共发布了三个规范，分别是运行时规范（runtime-spec）、镜像规范（image-spec）和分发规范（distribution-spec），有了以上的规范，就可以保证不同容器的可移植性和相互兼容性。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://containerd.io/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://gvisor.dev/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://podman.io/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://github.com/rkt/rkt</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #已停止维护</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://github.com/alibaba/pouch</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #阿里开源</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#安装文档，目前版本不支持Ubuntu 2204</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://github.com/AliyunContainerService/pouch/blob/master/INSTALLATION.md</span></span></code></pre></div><h3 id="_0-1-镜像构建方式" tabindex="-1">0.1 镜像构建方式 <a class="header-anchor" href="#_0-1-镜像构建方式" aria-label="Permalink to &quot;0.1 镜像构建方式&quot;">​</a></h3><h4 id="_0-1-1-使用主机构建" tabindex="-1">0.1.1 使用主机构建 <a class="header-anchor" href="#_0-1-1-使用主机构建" aria-label="Permalink to &quot;0.1.1 使用主机构建&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Docker</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #通用的容器镜像构建工具</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nerdctl+BuildKit+containerd</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #https://github.com/moby/buildkit ,下一代镜像构建工具</span></span></code></pre></div><p>图一：业务流程</p><p><img src="`+e+'" alt="业务流程"></p><p>图二：构建环境区别</p><p><img src="'+l+`" alt="构建环境区别"></p><h4 id="_0-1-2-kubernetes环境使用kaniko动态pod构建" tabindex="-1">0.1.2.kubernetes环境使用Kaniko动态Pod构建： <a class="header-anchor" href="#_0-1-2-kubernetes环境使用kaniko动态pod构建" aria-label="Permalink to &quot;0.1.2.kubernetes环境使用Kaniko动态Pod构建：&quot;">​</a></h4><p>参考： <a href="https://github.com/GoogleContainerTools/kaniko" target="_blank" rel="noreferrer">https://github.com/GoogleContainerTools/kaniko</a> #官方git仓库, 已不再更新 <a href="https://github.com/kaniko-build/builder" target="_blank" rel="noreferrer">https://github.com/kaniko-build/builder</a> #三方Git维护 <a href="https://gallery.ecr.aws/pergola/kaniko-project/executor" target="_blank" rel="noreferrer">https://gallery.ecr.aws/pergola/kaniko-project/executor</a> #AWS镜像仓库</p><h2 id="_1-部署buildkit" tabindex="-1">1 部署BuildKit <a class="header-anchor" href="#_1-部署buildkit" aria-label="Permalink to &quot;1 部署BuildKit&quot;">​</a></h2><ul><li>2017年由 docker 的创始人 ( tonistiigi 托尼斯蒂吉) 提议，将docker build 的能力独立成一个项目，针对构建的底层技术进行协作，更好复用和定制构建技术，该将项目即buildkit。</li><li>BuildKit是 Docker 官方社区推出的下一代镜像构建工具，官方宣称通过 BuildKit 可以更加快速、有效、安全地构建容器镜像。</li></ul><h3 id="_1-1-buildkit组成部分" tabindex="-1">1.1 BuildKit组成部分 <a class="header-anchor" href="#_1-1-buildkit组成部分" aria-label="Permalink to &quot;1.1 BuildKit组成部分&quot;">​</a></h3><p><a href="https://github.com/moby/buildkit" target="_blank" rel="noreferrer">https://github.com/moby/buildkit</a></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>buildkitd(服务端)，目前支持runc和containerd作为镜像构建环境，默认是runc，可以更换为containerd。</span></span>
<span class="line"><span>buildctl(客户端)，负责解析Dockerfile文件，并向服务端buildkitd发出构建请求。</span></span></code></pre></div><h3 id="_1-2-安装buildkitd" tabindex="-1">1.2 安装buildkitd <a class="header-anchor" href="#_1-2-安装buildkitd" aria-label="Permalink to &quot;1.2 安装buildkitd&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/usr/local/src#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pwd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/local/src</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/usr/local/src#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://github.com/moby/buildkit/releases/download/v0.26.3/buildkit-v0.26.3.linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/usr/local/src#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  buildkit-v0.26.3.linux-amd64.tar.gz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/usr/local/src#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bin/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/usr/local/src#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buildctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --help</span></span></code></pre></div><h3 id="_1-3-使用systemd-service运行" tabindex="-1">1.3 使用systemd service运行 <a class="header-anchor" href="#_1-3-使用systemd-service运行" aria-label="Permalink to &quot;1.3 使用systemd service运行&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>#buildkit.socket</span></span>
<span class="line"><span>root@k8s-master1:/usr/local/src# vim /lib/systemd/system/buildkit.socket</span></span>
<span class="line"><span>[Unit]</span></span>
<span class="line"><span>Description=BuildKit</span></span>
<span class="line"><span>Documentation=https://github.com/moby/buildkit</span></span>
<span class="line"><span>[Socket]</span></span>
<span class="line"><span>ListenStream=%t/buildkit/buildkitd.sock</span></span>
<span class="line"><span>SocketMode=0660</span></span>
<span class="line"><span>[Install]</span></span>
<span class="line"><span>WantedBy=sockets.target</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#buildkitd.service </span></span>
<span class="line"><span>root@k8s-master1:/usr/local/src# vim  /lib/systemd/system/buildkit.service </span></span>
<span class="line"><span>[Unit]</span></span>
<span class="line"><span>Description=BuildKit</span></span>
<span class="line"><span>Requires=buildkit.socket</span></span>
<span class="line"><span>After=buildkit.socketDocumentation=https://github.com/moby/buildkit</span></span>
<span class="line"><span>[Service]</span></span>
<span class="line"><span>ExecStart=/usr/local/bin/buildkitd --oci-worker=false --containerd-worker=true</span></span>
<span class="line"><span>[Install]</span></span>
<span class="line"><span>WantedBy=multi-user.target</span></span>
<span class="line"><span>root@k8s-master1:/usr/local/src# systemctl daemon-reload &amp;&amp; systemctl enable buildkit &amp;&amp; </span></span>
<span class="line"><span>systemctl restart  buildkit &amp;&amp; systemctl status  buildkit</span></span></code></pre></div><h2 id="_2测试镜像构建" tabindex="-1">2测试镜像构建 <a class="header-anchor" href="#_2测试镜像构建" aria-label="Permalink to &quot;2测试镜像构建&quot;">​</a></h2><h2 id="_2-1-nerdctl常用命令" tabindex="-1">2.1 nerdctl常用命令 <a class="header-anchor" href="#_2-1-nerdctl常用命令" aria-label="Permalink to &quot;2.1 nerdctl常用命令&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># nerdctl  login harbor.yourdomainname</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># nerdctl pull</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># nerdctl tag </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># nerdctl  push</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#信任自签发的证书</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># nerdctl --insecure-registry  push</span></span></code></pre></div><h2 id="_2-2-镜像构建" tabindex="-1">2.2 镜像构建 <a class="header-anchor" href="#_2-2-镜像构建" aria-label="Permalink to &quot;2.2 镜像构建&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cat Dockerfile </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/ubuntu:24.04.3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RUN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ca-certificates</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gnupg</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># cat build-command.sh </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/ubuntu:24.04.3-base</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/ubuntu:24.04.3-base</span></span></code></pre></div><p>执行构建脚本后可以使用浏览器访问harbor进行验证</p><h2 id="_3-基于自定义镜像创建容器" tabindex="-1">3 基于自定义镜像创建容器 <a class="header-anchor" href="#_3-基于自定义镜像创建容器" aria-label="Permalink to &quot;3 基于自定义镜像创建容器&quot;">​</a></h2><h3 id="_3-1-nerdctl命令创建测试容器" tabindex="-1">3.1 nerdctl命令创建测试容器 <a class="header-anchor" href="#_3-1-nerdctl命令创建测试容器" aria-label="Permalink to &quot;3.1 nerdctl命令创建测试容器&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#nerdctl run --rm -it -p 80:80 harbor.yourdomianname/myserver/nginx-base:ubuntu2204-nginx-1.28.1</span></span></code></pre></div><h3 id="_3-2-docker命令创建测试容器" tabindex="-1">3.2 docker命令创建测试容器 <a class="header-anchor" href="#_3-2-docker命令创建测试容器" aria-label="Permalink to &quot;3.2 docker命令创建测试容器&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#docker run --rm -it -p 80:80 harbor.yourdomianname/myserver/nginx-base:ubuntu2204-nginx-1.28.1</span></span></code></pre></div>`,32)])])}const b=a(p,[["render",h]]);export{g as __pageData,b as default};
