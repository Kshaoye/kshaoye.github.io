import{_ as s,c as e,o as t,ag as n}from"./chunks/framework.z0p7P-Mv.js";const u=JSON.parse('{"title":"etcd V3 API版本数据备份与恢复","description":"","frontmatter":{},"headers":[],"relativePath":"zh/k8s/etcdBackupAndRestore.md","filePath":"zh/k8s/etcdBackupAndRestore.md"}'),p={name:"zh/k8s/etcdBackupAndRestore.md"};function c(l,a,d,o,r,i){return t(),e("div",null,[...a[0]||(a[0]=[n(`<h1 id="etcd-v3-api版本数据备份与恢复" tabindex="-1">etcd V3 API版本数据备份与恢复 <a class="header-anchor" href="#etcd-v3-api版本数据备份与恢复" aria-label="Permalink to &quot;etcd V3 API版本数据备份与恢复&quot;">​</a></h1><h2 id="etcd集群备份" tabindex="-1">etcd集群备份 <a class="header-anchor" href="#etcd集群备份" aria-label="Permalink to &quot;etcd集群备份&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-etcd1:~# mkdir  /data </span></span>
<span class="line"><span>root@k8s-etcd1:~# cd /data/</span></span>
<span class="line"><span>root@k8s-etcd1:/data# etcdctl  snapshot save  snapshot.db</span></span></code></pre></div><h2 id="etcd集群恢复" tabindex="-1">etcd集群恢复 <a class="header-anchor" href="#etcd集群恢复" aria-label="Permalink to &quot;etcd集群恢复&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-etcd1:/data# etcdutl  snapshot status snapshot.db </span></span>
<span class="line"><span>root@k8s-etcd1:/data# etcdutl snapshot  restore ./snapshot.db --data-dir=/var/lib/etcd-data #将数据恢复到一个空的目录中</span></span></code></pre></div><h2 id="单机备份数据" tabindex="-1">单机备份数据 <a class="header-anchor" href="#单机备份数据" aria-label="Permalink to &quot;单机备份数据&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-etcd1:~# mkdir /data/etcd-backup-dir/ -p</span></span>
<span class="line"><span>root@k8s-etcd1:~# cat  etcd-backup.sh </span></span>
<span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span>source /etc/profile</span></span>
<span class="line"><span>DATE=\`date +%Y-%m-%d_%H-%M-%S\`	 #获取时间戳</span></span>
<span class="line"><span>ETCDCTL_API=3 /usr/local/bin/etcdctl  snapshot save  /data/etcd-backup-dir/etcd-snapshot-\${DATE}.db		#生成带时间戳的备份</span></span></code></pre></div><h2 id="恢复测试" tabindex="-1">恢复测试 <a class="header-anchor" href="#恢复测试" aria-label="Permalink to &quot;恢复测试&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>#使用ezctl备份集群</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# ./ezctl backup  k8s-cluster1</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# kubectl  get deployment -n myserver</span></span>
<span class="line"><span>#删除myserver-nginx-deployment</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# kubectl  delete deployment -n myserver myserver-nginx-deployment</span></span>
<span class="line"><span>##注意，在恢复数据期间API server不可用，必须在业务低峰期操作或者是在其它紧急场景：</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# grep  db_to_restore ./roles/ -R #选择恢复的文件</span></span>
<span class="line"><span>./roles/cluster-restore/defaults/main.yml:db_to_restore: &quot;snapshot.db&quot;</span></span>
<span class="line"><span>./roles/cluster-restore/tasks/main.yml:    src: &quot;{{ cluster_dir }}/backup/{{ db_to_restore }}</span></span>
<span class="line"><span>root@k8s-master1:/etc/kubeasz# ./ezctl restore k8s-cluster1 #v3.3.1</span></span></code></pre></div>`,9)])])}const k=s(p,[["render",c]]);export{u as __pageData,k as default};
