<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于kubeasz的k8s v1.34.x高可用集群部署 | Kevin Crimson</title>
    <meta name="description" content="Navigating the digital era while rediscovering the balance between ancient Chinese wisdom and modern life.">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/assets/style.Cd2xXf54.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DUVg2eNu.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CSx4Rv_w.js">
    <link rel="modulepreload" href="/assets/chunks/framework.z0p7P-Mv.js">
    <link rel="modulepreload" href="/assets/zh_k8s_DeployK8sClusterWithKubeasz.md.DvPXF1ja.lean.js">
    <link rel="icon" href="/img/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/" data-v-1168a8e4><!--[--><!--]--><!--[--><img class="VPImage logo" src="/img/crimson.png" alt data-v-8426fc1a><!--]--><span data-v-1168a8e4>Kevin Crimson</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/k8s/index.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Kubernetes</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/Prometheus/index.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>Prometheus</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>Banlance</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/zh/balance/MartialArts/index.html" data-v-35975db6><!--[--><span data-v-35975db6>MartialArts</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/zh/balance/Musings/index.html" data-v-35975db6><!--[--><span data-v-35975db6>Musings</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>Other</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/zh/AboutMe.html" data-v-35975db6><!--[--><span data-v-35975db6>About Me</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-6aa21345 data-v-88af2de4 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><span class="vpi-languages option-icon" data-v-cf11d7a2></span><!----><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><div class="items" data-v-88af2de4><p class="title" data-v-88af2de4>简体中文</p><!--[--><div class="VPMenuLink" data-v-88af2de4 data-v-35975db6><a class="VPLink link" href="/en/" data-v-35975db6><!--[--><span data-v-35975db6>English</span><!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><div class="group translations" data-v-bb2aa2f0><p class="trans-title" data-v-bb2aa2f0>简体中文</p><!--[--><div class="VPMenuLink" data-v-bb2aa2f0 data-v-35975db6><a class="VPLink link" href="/en/" data-v-35975db6><!--[--><span data-v-35975db6>English</span><!--]--></a></div><!--]--></div><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>返回顶部</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>目录</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _zh_k8s_DeployK8sClusterWithKubeasz" data-v-39a288b8><div><h1 id="基于kubeasz的k8s-v1-34-x高可用集群部署" tabindex="-1">基于kubeasz的k8s v1.34.x高可用集群部署 <a class="header-anchor" href="#基于kubeasz的k8s-v1-34-x高可用集群部署" aria-label="Permalink to &quot;基于kubeasz的k8s v1.34.x高可用集群部署&quot;">​</a></h1><h2 id="_1-1-部署目标" tabindex="-1">1.1 部署目标 <a class="header-anchor" href="#_1-1-部署目标" aria-label="Permalink to &quot;1.1 部署目标&quot;">​</a></h2><p>1、完成kubernetes管理端服务（kube-apiserver、kube-controller-manager、kube-scheduler）的高可用部署。</p><p>2、完成node节点上的客户端服务(kubelet、kube-proxy）的部署。</p><h2 id="_1-2-集群架构" tabindex="-1">1.2 集群架构 <a class="header-anchor" href="#_1-2-集群架构" aria-label="Permalink to &quot;1.2 集群架构&quot;">​</a></h2><table tabindex="0"><thead><tr><th>节点类型</th><th>数量</th><th>功能</th><th>IP</th></tr></thead><tbody><tr><td>master</td><td>2</td><td>k8s控制端</td><td>172.31.7.101、102</td></tr><tr><td>harbor</td><td>1</td><td>镜像服务器</td><td>172.31.7.104</td></tr><tr><td>etcd</td><td>1</td><td>保存集群数据</td><td>172.31.7.106</td></tr><tr><td>HA</td><td>1</td><td>高可用</td><td>172.31.7.109</td></tr><tr><td>deploy</td><td>1</td><td>部署用、后期可作为HA</td><td>172.31.7.110</td></tr><tr><td>node</td><td>2</td><td>运行容器</td><td>172.31.7.111、112</td></tr></tbody></table><h2 id="_1-3-集群软件环境" tabindex="-1">1.3 集群软件环境 <a class="header-anchor" href="#_1-3-集群软件环境" aria-label="Permalink to &quot;1.3 集群软件环境&quot;">​</a></h2><p>对外API端口：172.31.7.188:6443</p><p>操作系统：Ubuntu 22.04.2 LTS</p><p>k8s版本：1.34.2</p><p>calico版本：3.24.8</p><h2 id="_1-4-基础环境部署" tabindex="-1">1.4 基础环境部署 <a class="header-anchor" href="#_1-4-基础环境部署" aria-label="Permalink to &quot;1.4 基础环境部署&quot;">​</a></h2><p>系统主机名配置、IP配置、系统参数优化，以及依赖的负载均衡和Harbor部署</p><h3 id="_1-4-1-系统配置及主机名解析" tabindex="-1">1.4.1 系统配置及主机名解析 <a class="header-anchor" href="#_1-4-1-系统配置及主机名解析" aria-label="Permalink to &quot;1.4.1 系统配置及主机名解析&quot;">​</a></h3><p>iptables、防火墙、内核参数与资源限制等系统配置可以通过脚本批量设置，master会使用添加node时候使用的名称与node通信。</p><h3 id="_1-4-2-ha-high-available-高可用负载均衡" tabindex="-1">1.4.2 HA（High Available）高可用负载均衡 <a class="header-anchor" href="#_1-4-2-ha-high-available-高可用负载均衡" aria-label="Permalink to &quot;1.4.2  HA（High Available）高可用负载均衡&quot;">​</a></h3><p>主要目的：将master节点做为后端，实现k8s集群的高可用反向代理。</p><p>安装keepalived+haproxy后先修改keepalived配置：</p><p>sudo apt update</p><p>sudo apt install keepalived haproxy</p><p>sudo vim /etc/keepalived/keepalived.conf</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>global_defs {</span></span>
<span class="line"><span>    vrrp_skip_check_adv_addr</span></span>
<span class="line"><span>    #vrrp_strict #此处注释掉可以解除vip的禁ping限制</span></span>
<span class="line"><span>    vrrp_garp_interval 0</span></span>
<span class="line"><span>    vrrp_gna_interval 0</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state MASTER</span></span>
<span class="line"><span>    interface ens3 #此处依据实际网卡名配置</span></span>
<span class="line"><span>    virtual_router_id 51</span></span>
<span class="line"><span>    priority 100</span></span>
<span class="line"><span>    advert_int 1</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass 1111</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {#以下依据实际网卡名配置</span></span>
<span class="line"><span>        172.31.7.188 dev ens3 label ens3:0</span></span>
<span class="line"><span>        172.31.7.189 dev ens3 label ens3:1</span></span>
<span class="line"><span>        172.31.7.190 dev ens3 label ens3:2</span></span>
<span class="line"><span>        172.31.7.191 dev ens3 label ens3:3</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>重启keepalived服务并设为开机自启动</p><p>systemctl restart keeepalived.service</p><p>systemctl enable keepalived.service</p><p>sudo vim /etc/haproxy/haproxy.cfg</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>listen k8s-6443</span></span>
<span class="line"><span>	bind 172.31.7.188:6443</span></span>
<span class="line"><span>	mode tcp</span></span>
<span class="line"><span>	server master01 172.31.7.101:6443 check inter 3s fall 3 rise 5</span></span>
<span class="line"><span>	server master02 172.31.7.102:6443 check inter 3s fall 3 rise 5</span></span></code></pre></div><p>重启haproxy服务 sudo systemctl restart haproxy.service</p><h3 id="_1-4-3-安装运行时并部署镜像仓库harbor" tabindex="-1">1.4.3 安装运行时并部署镜像仓库harbor <a class="header-anchor" href="#_1-4-3-安装运行时并部署镜像仓库harbor" aria-label="Permalink to &quot;1.4.3 安装运行时并部署镜像仓库harbor&quot;">​</a></h3><p>kubernetes master节点和node节点使用containerd作为运行时，</p><p>harbor节点安装docker用于部署harbor，containerd。</p><p>目前harbor的安装脚本会强制检查docker及docker-compose是否安装。</p><p>可以使用apt或者二进制等方式批量安装。</p><h3 id="_1-4-4-支持https访问的harbor部署" tabindex="-1">1.4.4 支持https访问的Harbor部署 <a class="header-anchor" href="#_1-4-4-支持https访问的harbor部署" aria-label="Permalink to &quot;1.4.4 支持https访问的Harbor部署&quot;">​</a></h3><p>集群业务镜像将统一上传到Harbor的服务器并实现镜像分发， 不再通过互联网在线下载公网镜像，提高镜像分发效率及数据安全性。</p><p>安装参考： <a href="https://goharbor.io/docs/2.5.0/install-config/configure-https/" target="_blank" rel="noreferrer">https://goharbor.io/docs/2.5.0/install-config/configure-https/</a></p><p>下载harbor离线安装包并放在/apps目录，同时准备一个certs目录用于接下来存放ssl证书</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-harbor1:/usr/local/src# mkdir /apps/</span></span>
<span class="line"><span>root@k8s-harbor1:/usr/local/src# mv harbor-offline-installer-v2.14.0.tgz /apps/</span></span>
<span class="line"><span>root@k8s-harbor1:/usr/local/src# cd /apps/</span></span>
<span class="line"><span>root@k8s-harbor1:/apps# tar xvf harbor-offline-installer-v2.14.0.tgz</span></span>
<span class="line"><span>root@k8s-harbor1:/apps# cd harbor/</span></span>
<span class="line"><span>root@k8s-harbor1:/apps/harbor# mkdir certs</span></span>
<span class="line"><span>root@k8s-harbor1:/apps/harbor# cd certs/</span></span></code></pre></div><h4 id="_1-4-4-1-申请并下载ssl证书" tabindex="-1">1.4.4.1 申请并下载SSL证书 <a class="header-anchor" href="#_1-4-4-1-申请并下载ssl证书" aria-label="Permalink to &quot;1.4.4.1 申请并下载SSL证书&quot;">​</a></h4><p>生产环境推荐使用公有证书签发机构签发的证书、证书签发机构的证书(免费或付费)，可被信任。</p><p>目前各云厂商通常可提供90天的单域名免费证书，”时巴克科技“可提供90天的通配符证书，通配符证书支持一个域名的所有下一级子域名，例如 *.spug.cc 可用于 a.spug.cc 或 b.spug.cc，但不能用于 a.b.spug.cc。</p><p>下载回来的证书文件中pem后缀的是公钥，key后缀的是私钥。</p><p>可以放在刚才已经准备好的/apps/harbor/certs目录</p><h4 id="_1-4-4-2-修改harbor配置文件harbor-yaml" tabindex="-1">1.4.4.2 修改harbor配置文件harbor.yaml <a class="header-anchor" href="#_1-4-4-2-修改harbor配置文件harbor-yaml" aria-label="Permalink to &quot;1.4.4.2 修改harbor配置文件harbor.yaml&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-harbor1:/apps/harbor/certs# unzip harbor.myarchitect.online_nginx.zip</span></span>
<span class="line"><span>root@k8s-harbor1:/apps/harbor/certs# ll</span></span>
<span class="line"><span>total 28</span></span>
<span class="line"><span>drwxr-xr-x 2 root root 123 Oct 13 16:49 ./</span></span>
<span class="line"><span>drwxr-xr-x 4 root root 4096 Oct 13 16:52 ../</span></span>
<span class="line"><span>-rw------- 1 root root 1675 Oct 13 16:48 harbor.myarchitect.online.key</span></span>
<span class="line"><span>-rw------- 1 root root 6955 Oct 13 16:48 harbor.myarchitect.online.pem</span></span>
<span class="line"><span>-rw-r--r-- 1 root root 8920 Oct 13 16:48 harbor.myarchitect.online_nginx.zip</span></span>
<span class="line"><span>root@k8s-harbor1:/apps/harbor/certs# cd ..</span></span>
<span class="line"><span>root@k8s-harbor1:/apps/harbor# vim harbor.yml</span></span>
<span class="line"><span># The IP address or hostname to access admin UI and registry service.</span></span>
<span class="line"><span># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external</span></span>
<span class="line"><span>clients.</span></span>
<span class="line"><span># 此处用你的域名替换&quot;yourdomainname&quot;</span></span>
<span class="line"><span>hostname: harbor.yourdomainname</span></span>
<span class="line"><span># http related config</span></span>
<span class="line"><span>http:</span></span>
<span class="line"><span># port for http, default is 80. If https enabled, this port will redirect to https port</span></span>
<span class="line"><span>port: 80</span></span>
<span class="line"><span># https related config</span></span>
<span class="line"><span>https:</span></span>
<span class="line"><span># https port for harbor, default is 443</span></span>
<span class="line"><span>port: 443</span></span>
<span class="line"><span># The path of cert and key files for nginx</span></span>
<span class="line"><span># 此处用你的域名替换&quot;yourdomainname&quot;</span></span>
<span class="line"><span>certificate: /apps/harbor/certs/harbor.yourdomainname.pem</span></span>
<span class="line"><span>private_key: /apps/harbor/certs/harbor.yourdomainname.key</span></span>
<span class="line"><span># enable strong ssl ciphers (default: false)</span></span>
<span class="line"><span># strong_ssl_ciphers: false</span></span></code></pre></div><h4 id="_1-4-4-3-执行install-sh完成部署" tabindex="-1">1.4.4.3 执行install.sh完成部署 <a class="header-anchor" href="#_1-4-4-3-执行install-sh完成部署" aria-label="Permalink to &quot;1.4.4.3 执行install.sh完成部署&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-harbor1:/apps/harbor# ./install.sh --with-trivy</span></span></code></pre></div><p>部署完后可以使用浏览器访问harbor进行测试</p><h4 id="_1-4-4-4-nerdctl测试登录harbor" tabindex="-1">1.4.4.4 nerdctl测试登录harbor <a class="header-anchor" href="#_1-4-4-4-nerdctl测试登录harbor" aria-label="Permalink to &quot;1.4.4.4 nerdctl测试登录harbor&quot;">​</a></h4><p>确认浏览器访问正常后可以在deploy节点测试登录harbor服务器，以验证是否能够登录harbor及push镜像。 （如果部署多台harbor，可以在其他harbor节点测试） 测试时可以先修改本地HOSTS文件解析harbor服务器域名：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-harbor1:/usr/local/src# cat /etc/hosts</span></span>
<span class="line"><span>172.31.7.104 harbor.yourdomainname</span></span>
<span class="line"><span>root@k8s-harbor1:/usr/local/src#nerdctl login harbor.yourdomainname</span></span></code></pre></div><p>看到Login Succeeded字样即测试成功</p><h4 id="_1-4-4-5-测试nerdctl下载镜像并上传到harbor仓库" tabindex="-1">1.4.4.5 测试nerdctl下载镜像并上传到harbor仓库 <a class="header-anchor" href="#_1-4-4-5-测试nerdctl下载镜像并上传到harbor仓库" aria-label="Permalink to &quot;1.4.4.5 测试nerdctl下载镜像并上传到harbor仓库&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-harbor1:~# nerdctl pull registry.cn-hangzhou.aliyuncs.com/myhubregistry/rockylinux:9.3.20231119</span></span>
<span class="line"><span>root@k8s-harbor1:~# nerdctl tag registry.cn-hangzhou.aliyuncs.com/myhubregistry/rockylinux:9.3.20231119 harbor.yourdomainname/baseimages/rockylinux:9.3.20231119</span></span>
<span class="line"><span>root@k8s-harbor1:/usr/local/src# nerdctl push harbor.yourdomainname/baseimages/rockylinux:9.3.20231119</span></span></code></pre></div><h4 id="_1-4-4-6-配置harbor服务" tabindex="-1">1.4.4.6 配置harbor服务 <a class="header-anchor" href="#_1-4-4-6-配置harbor服务" aria-label="Permalink to &quot;1.4.4.6 配置harbor服务&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-harbor1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/lib/systemd/system/harbor.service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Harbor</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">After</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker.service</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> systemd-networkd.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd-resolved.service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Requires</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker.service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Documentation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">http://github.com/vmware/harbor</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">simple</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Restart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">on-failure</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RestartSec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecStart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/bin/docker-compose</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /apps/harbor/docker-compose.yml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecStop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/docker-compose</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /apps/harbor/docker-compose.yml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> down</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WantedBy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">multi-user.target</span></span></code></pre></div><h2 id="_1-5-部署节点初始化" tabindex="-1">1.5 部署节点初始化 <a class="header-anchor" href="#_1-5-部署节点初始化" aria-label="Permalink to &quot;1.5 部署节点初始化&quot;">​</a></h2><p>部署节点为172.31.7.110，主要作用如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1、从互联网下载安装资源</span></span>
<span class="line"><span>2、可选将部分镜像修改tag后上传到集群内部镜像仓库服务器</span></span>
<span class="line"><span>3、对master进行初始化</span></span>
<span class="line"><span>4、对node进行初始化</span></span>
<span class="line"><span>5、后期集群维护</span></span>
<span class="line"><span>	添加及删除master节点</span></span>
<span class="line"><span>	添加就删除node节点</span></span>
<span class="line"><span>	etcd数据备份及恢复</span></span></code></pre></div><p>使用kubeasz载部署kubernetes过程中 的各种镜像及二进制文件等资源，需要安装docker环境。 另外此节点为后期也可能会向harbor上传下载镜像，因此也需要登录habror并上传下载镜像。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubeasz项目地址：https://github.com/easzlab/kubeasz</span></span>
<span class="line"><span>由于节点需要使用docker下载k8s集群部署过程中需要的各种镜像及二进制文件等资源，需要安装docker环境。</span></span>
<span class="line"><span>另外，此节点为docker环境但是后期也可能会向harbor上传下载镜像，因此也需要登录habror并上传下载镜像。</span></span></code></pre></div><p>root@k8s-deploy:vim /usr/local/src# cat /etc/hosts 172.31.7.104 harbor.yourdomainname root@k8s-deploy:/usr/local/src#docker login harbor.yourdomainname</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Username: admin</span></span>
<span class="line"><span>Password:</span></span>
<span class="line"><span>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span></span>
<span class="line"><span>Configure a credential helper to remove this warning. See</span></span>
<span class="line"><span>https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span>
<span class="line"><span>Login Succeeded</span></span>
<span class="line"><span>#测试镜像下载和上传</span></span>
<span class="line"><span>root@k8s-deploy:~# docker pull registry.cn-hangzhou.</span></span>
<span class="line"><span>aliyuncs.com/myhubregistry/rockylinux:10.0.20250606</span></span>
<span class="line"><span>root@k8s-deploy:~# docker tag registry.cn-hangzhou.</span></span>
<span class="line"><span>aliyuncs.com/myhubregistry/rockylinux:10.0.20250606</span></span>
<span class="line"><span>harbor.yourdomainname/baseimages/rockylinux:10.0.20250606</span></span>
<span class="line"><span>root@k8s-deploy:~# docker push harbor.yourdomainname/baseimages/rockylinux:10.0.20250606</span></span></code></pre></div><h2 id="_1-6-kubeasz部署高可用kubernetes" tabindex="-1">1.6 kubeasz部署高可用kubernetes <a class="header-anchor" href="#_1-6-kubeasz部署高可用kubernetes" aria-label="Permalink to &quot;1.6 kubeasz部署高可用kubernetes&quot;">​</a></h2><p>kubeasz致力于提供快速部署高可用k8s集群的工具, 同时也努力成为k8s实践、使用的参考书；基于二进制方式部署和利用ansible-playbook实现自动化；既提供一键安装脚本, 也可以根据安装指南分步执行安装各个组件。</p><p>kubeasz从每一个单独部件组装到完整的集群，提供最灵活的配置能力，几乎可以设置任何组件的任何参数；同时又为集群创建预置一套运行良好的默认配置，甚至自动化创建适合大规模集群的BGP Route Reflector网络模式。</p><h3 id="_1-6-1-免秘钥登录配置" tabindex="-1">1.6.1 免秘钥登录配置 <a class="header-anchor" href="#_1-6-1-免秘钥登录配置" aria-label="Permalink to &quot;1.6.1 免秘钥登录配置&quot;">​</a></h3><p>将部署节点的公钥分发至master、node、etcd节点。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa-sha2-512</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshpass</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #安装sshpass命令用于同步公钥到各k8s服务器</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> key-scp.sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#目标主机列表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">IP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.101</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.102</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.104</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.106</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.109</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.111</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.31.7.112</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_PORT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;22&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_USER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ubuntu&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_PASS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mageedu&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建或清空日志文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LOG_FILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ssh_config.log&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;开始配置免密钥登录 - $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">date</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$LOG_FILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> REMOTE_HOST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ${IP};</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;正在配置 </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ...&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #添加目标远程主机的公钥</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;添加 </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 到 known_hosts...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ssh-keyscan</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/known_hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 设置know_hosts文件权限</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/known_hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #通过sshpass配置免秘钥登录、并创建python3软连接</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;配置SSH秘钥...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    sshpass</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_PASS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ssh-copy-id</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}@${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 检查SSH连接是否成功</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ConnectTimeout=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BatchMode=yes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;exit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;创建python3软链接...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMORE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}@${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;sudo ln -sv /usr/bin/python3 /usr/bin/python || true&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 验证设置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;hostname &amp;&amp; python --version &amp;&amp; whoami&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: 配置完成&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$LOG_FILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} 免秘钥配置完成!&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: SSH连接失败&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$LOG_FILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;警告: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置失败!&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fi</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;------------------------------------------------&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;配置完成！详情可查看日志文件:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$LOG_FILE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#执行脚本同步：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">roo@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> key-scp.sh</span></span></code></pre></div><p>执行完通过ssh命令确认deploy可以免密登录集群内的其他服务器。</p><h3 id="_1-6-2-下载kubeasz项目及组件" tabindex="-1">1.6.2 下载kubeasz项目及组件 <a class="header-anchor" href="#_1-6-2-下载kubeasz项目及组件" aria-label="Permalink to &quot;1.6.2 下载kubeasz项目及组件&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:~# apt install git</span></span>
<span class="line"><span>root@k8s-deploy:~# export release=3.6.8</span></span>
<span class="line"><span>root@k8s-deploy:~# wget</span></span>
<span class="line"><span>https://github.com/easzlab/kubeasz/releases/download/${release}/ezdown</span></span>
<span class="line"><span>root@k8s-deploy:~# vim ezdown #可选自定义下载组件版本</span></span>
<span class="line"><span>root@k8s-deploy:~# chmod +x ./ezdown</span></span>
<span class="line"><span>root@k8s-deploy:~# ./ezdown -D #此步骤需要能从docker官方镜像仓库下载镜像、并需要几分钟下载时间</span></span>
<span class="line"><span>root@k8s-deploy:~# ll /etc/kubeasz/</span></span>
<span class="line"><span>total 120</span></span>
<span class="line"><span>drwxrwxr-x 12 root root 4096 Oct 13 18:36 ./</span></span>
<span class="line"><span>drwxr-xr-x 115 root root 8192 Oct 13 18:36 ../</span></span>
<span class="line"><span>drwxrwxr-x 4 root root 77 Sep 14 19:56 .github/</span></span>
<span class="line"><span>-rw-rw-r-- 1 root root 322 Sep 14 19:45 .gitignore</span></span>
<span class="line"><span>-rw-rw-r-- 1 root root 6445 Sep 14 19:45 README.md</span></span>
<span class="line"><span>-rw-rw-r-- 1 root root 20304 Sep 14 19:45 ansible.cfg</span></span>
<span class="line"><span>drwxr-xr-x 5 root root 4096 Oct 13 18:36 bin/</span></span>
<span class="line"><span>drwxrwxr-x 8 root root 94 Sep 14 19:56 docs/</span></span>
<span class="line"><span>drwxr-xr-x 2 root root 4096 Oct 13 18:39 down/</span></span>
<span class="line"><span>drwxrwxr-x 2 root root 70 Sep 14 19:56 example/</span></span>
<span class="line"><span>-rwxrwxr-x 1 root root 26440 Sep 14 19:45 ezctl*</span></span>
<span class="line"><span>-rwxrwxr-x 1 root root 26635 Sep 14 19:45 ezdown*</span></span>
<span class="line"><span>drwxrwxr-x 3 root root 24 Sep 14 19:56 manifests/</span></span>
<span class="line"><span>drwxrwxr-x 2 root root 94 Sep 14 19:56 pics/</span></span>
<span class="line"><span>drwxrwxr-x 2 root root 4096 Sep 14 19:56 playbooks/</span></span>
<span class="line"><span>drwxrwxr-x 22 root root 4096 Sep 14 19:56 roles/</span></span>
<span class="line"><span>drwxrwxr-x 2 root root 90 Sep 14 19:56 tools/</span></span></code></pre></div><h3 id="_1-6-3-生成并自定义kubeasz的hosts文件" tabindex="-1">1.6.3 生成并自定义kubeasz的hosts文件 <a class="header-anchor" href="#_1-6-3-生成并自定义kubeasz的hosts文件" aria-label="Permalink to &quot;1.6.3 生成并自定义kubeasz的hosts文件&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:~# cd /etc/kubeasz/</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# pwd</span></span>
<span class="line"><span>/etc/kubeasz</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# ./ezctl new k8s-cluster1</span></span>
<span class="line"><span>2025-10-16 14:39:06 [ezctl:145] DEBUG generate custom cluster files in</span></span>
<span class="line"><span>/etc/kubeasz/clusters/k8s-cluster1</span></span>
<span class="line"><span>2025-10-16 14:39:06 [ezctl:151] DEBUG set versions</span></span>
<span class="line"><span>2025-10-16 14:39:06 [ezctl:182] DEBUG cluster k8s-cluster1: files successfully created.</span></span>
<span class="line"><span>2025-10-16 14:39:06 [ezctl:183] INFO next steps 1: to config &#39;/etc/kubeasz/clusters/k8scluster1/</span></span>
<span class="line"><span>hosts&#39;</span></span>
<span class="line"><span>2025-10-16 14:39:06 [ezctl:184] INFO next steps 2: to config &#39;/etc/kubeasz/clusters/k8scluster1/</span></span>
<span class="line"><span>config.yml&#39;</span></span></code></pre></div><h4 id="_1-6-3-1-编辑ansible-hosts文件" tabindex="-1">1.6.3.1 编辑ansible hosts文件 <a class="header-anchor" href="#_1-6-3-1-编辑ansible-hosts文件" aria-label="Permalink to &quot;1.6.3.1 编辑ansible hosts文件&quot;">​</a></h4><p>指定etcd节点、master节点、node节点、VIP、运行时、网络组建类型、service IP与pod IP范围等配置信息。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:/etc/kubeasz# cat clusters/k8s-cluster1/hosts</span></span>
<span class="line"><span># &#39;etcd&#39; cluster should have odd member(s) (1,3,5,...)</span></span>
<span class="line"><span>[etcd]</span></span>
<span class="line"><span>172.31.7.106</span></span>
<span class="line"><span># master node(s), set unique &#39;k8s_nodename&#39; for each node</span></span>
<span class="line"><span># CAUTION: &#39;k8s_nodename&#39; must consist of lower case alphanumeric characters, &#39;-&#39; or &#39;.&#39;,</span></span>
<span class="line"><span># and must start and end with an alphanumeric character</span></span>
<span class="line"><span>[kube_master]</span></span>
<span class="line"><span>172.31.7.101 k8s_nodename=&#39;172.31.7.101&#39;</span></span>
<span class="line"><span>172.31.7.102 k8s_nodename=&#39;172.31.7.102&#39;</span></span>
<span class="line"><span># work node(s), set unique &#39;k8s_nodename&#39; for each node</span></span>
<span class="line"><span># CAUTION: &#39;k8s_nodename&#39; must consist of lower case alphanumeric characters, &#39;-&#39; or &#39;.&#39;,</span></span>
<span class="line"><span># and must start and end with an alphanumeric character</span></span>
<span class="line"><span>[kube_node]</span></span>
<span class="line"><span>172.31.7.111 k8s_nodename=&#39;172.31.7.111&#39;</span></span>
<span class="line"><span>172.31.7.112 k8s_nodename=&#39;172.31.7.112&#39;</span></span>
<span class="line"><span># [optional] harbor server, a private docker registry</span></span>
<span class="line"><span># &#39;NEW_INSTALL&#39;: &#39;true&#39; to install a harbor server; &#39;false&#39; to integrate with existed one</span></span>
<span class="line"><span>[harbor]</span></span>
<span class="line"><span>#172.31.7.8 NEW_INSTALL=false</span></span>
<span class="line"><span># [optional] loadbalance for accessing k8s from outside</span></span>
<span class="line"><span>[ex_lb]</span></span>
<span class="line"><span>#172.31.7.6 LB_ROLE=backup EX_APISERVER_VIP=172.31.7.188 EX_APISERVER_PORT=8443</span></span>
<span class="line"><span>#172.31.7.7 LB_ROLE=master EX_APISERVER_VIP=172.31.7.188 EX_APISERVER_PORT=8443</span></span>
<span class="line"><span># [optional] ntp server for the cluster</span></span>
<span class="line"><span>[chrony]</span></span>
<span class="line"><span>#172.31.7.1</span></span>
<span class="line"><span>[all:vars]</span></span>
<span class="line"><span># --------- Main Variables ---------------</span></span>
<span class="line"><span># Secure port for apiservers</span></span>
<span class="line"><span>SECURE_PORT=&quot;6443&quot;</span></span>
<span class="line"><span># Cluster container-runtime supported: docker, containerd</span></span>
<span class="line"><span># if k8s version &gt;= 1.24, docker is not supported</span></span>
<span class="line"><span>CONTAINER_RUNTIME=&quot;containerd&quot;</span></span>
<span class="line"><span># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span></span>
<span class="line"><span>CLUSTER_NETWORK=&quot;calico&quot;</span></span>
<span class="line"><span># Service proxy mode of kube-proxy: &#39;iptables&#39; or &#39;ipvs&#39;</span></span>
<span class="line"><span>PROXY_MODE=&quot;ipvs&quot;</span></span>
<span class="line"><span># K8S Service CIDR, not overlap with node(host) networking</span></span>
<span class="line"><span>SERVICE_CIDR=&quot;10.100.0.0/16&quot;</span></span>
<span class="line"><span># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span></span>
<span class="line"><span>CLUSTER_CIDR=&quot;10.200.0.0/16&quot;</span></span>
<span class="line"><span># NodePort Range</span></span>
<span class="line"><span>NODE_PORT_RANGE=&quot;30000-62767&quot;</span></span>
<span class="line"><span># Cluster DNS Domain</span></span>
<span class="line"><span>CLUSTER_DNS_DOMAIN=&quot;cluster.local&quot;</span></span>
<span class="line"><span># -------- Additional Variables (don&#39;t change the default value right now) ---</span></span>
<span class="line"><span># Binaries Directory</span></span>
<span class="line"><span># 注意路径不要写错，错了改起来很麻烦，别问我怎么知道的。</span></span>
<span class="line"><span>bin_dir=&quot;/usr/local/bin&quot;</span></span>
<span class="line"><span># Deploy Directory (kubeasz workspace)</span></span>
<span class="line"><span>base_dir=&quot;/etc/kubeasz&quot;</span></span>
<span class="line"><span># Directory for a specific cluster</span></span>
<span class="line"><span>cluster_dir=&quot;{{ base_dir }}/clusters/k8s-cluster1&quot;</span></span>
<span class="line"><span># CA and other components cert/key Directory</span></span>
<span class="line"><span>ca_dir=&quot;/etc/kubernetes/ssl&quot;</span></span>
<span class="line"><span># Default &#39;k8s_nodename&#39; is empty</span></span>
<span class="line"><span>k8s_nodename=&#39;&#39;</span></span>
<span class="line"><span># Default python interpreter</span></span>
<span class="line"><span>ansible_python_interpreter=/usr/bin/python3</span></span>
<span class="line"><span># 如果不使用root用户，而是使用ubuntu用户免密sudo执行ansible，可以添加以下内容</span></span>
<span class="line"><span># 如果直接使用root用户，请删除或注释以下内容</span></span>
<span class="line"><span>ansible_ssh_user=ubuntu</span></span>
<span class="line"><span>ansible_ssh_private_key_file=/home/ubuntu/.ssh/id_rsa</span></span>
<span class="line"><span>ansible_become=yes</span></span>
<span class="line"><span>ansible_become_method=sudo</span></span>
<span class="line"><span>ansible_become_user=root</span></span></code></pre></div><h4 id="_1-6-3-2-编辑集群配置文件config-yml" tabindex="-1">1.6.3.2 编辑集群配置文件config.yml <a class="header-anchor" href="#_1-6-3-2-编辑集群配置文件config-yml" aria-label="Permalink to &quot;1.6.3.2 编辑集群配置文件config.yml&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:/etc/kubeasz# vim clusters/k8s-cluster1/config.yml</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# cat clusters/k8s-cluster1/config.yml</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># prepare</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># 可选离线安装系统软件包 (offline|online)</span></span>
<span class="line"><span>INSTALL_SOURCE: &quot;online&quot;</span></span>
<span class="line"><span># 可选进行系统安全加固 github.com/dev-sec/ansible-collection-hardening</span></span>
<span class="line"><span># (deprecated) 未更新上游项目，未验证最新k8s集群安装，不建议启用</span></span>
<span class="line"><span>OS_HARDEN: false</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:deploy</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># default: ca will expire in 100 years</span></span>
<span class="line"><span># default: certs issued by the ca will expire in 50 years</span></span>
<span class="line"><span>CA_EXPIRY: &quot;876000h&quot;</span></span>
<span class="line"><span>CERT_EXPIRY: &quot;438000h&quot;</span></span>
<span class="line"><span># force to recreate CA and other certs, not suggested to set &#39;true&#39;</span></span>
<span class="line"><span>CHANGE_CA: false</span></span>
<span class="line"><span># kubeconfig 配置参数</span></span>
<span class="line"><span>CLUSTER_NAME: &quot;cluster1&quot;</span></span>
<span class="line"><span>CONTEXT_NAME: &quot;context-{{ CLUSTER_NAME }}&quot;</span></span>
<span class="line"><span># k8s version</span></span>
<span class="line"><span>K8S_VER: &quot;1.34.1&quot;</span></span>
<span class="line"><span># set unique &#39;k8s_nodename&#39; for each node, if not set(default:&#39;&#39;) ip add will be used</span></span>
<span class="line"><span># CAUTION: &#39;k8s_nodename&#39; must consist of lower case alphanumeric characters, &#39;-&#39; or &#39;.&#39;,</span></span>
<span class="line"><span># and must start and end with an alphanumeric character (e.g. &#39;example.com&#39;),</span></span>
<span class="line"><span># regex used for validation is &#39;[a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-</span></span>
<span class="line"><span>9])?)*&#39;</span></span>
<span class="line"><span>K8S_NODENAME: &quot;{%- if k8s_nodename != &#39;&#39; -%} \</span></span>
<span class="line"><span>{{ k8s_nodename|replace(&#39;_&#39;, &#39;-&#39;)|lower }} \</span></span>
<span class="line"><span>{%- else -%} \</span></span>
<span class="line"><span>k8s-{{ inventory_hostname|replace(&#39;.&#39;, &#39;-&#39;) }} \</span></span>
<span class="line"><span>{%- endif -%}&quot;</span></span>
<span class="line"><span># use &#39;K8S_NODENAME&#39; to set hostname</span></span>
<span class="line"><span>ENABLE_SETTING_HOSTNAME: false</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:etcd</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># 设置不同的wal目录，可以避免磁盘io竞争，提高性能</span></span>
<span class="line"><span>ETCD_DATA_DIR: &quot;/var/lib/etcd&quot;</span></span>
<span class="line"><span>ETCD_WAL_DIR: &quot;&quot;</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:runtime [containerd,docker]</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># [.]启用拉取加速镜像仓库</span></span>
<span class="line"><span>ENABLE_MIRROR_REGISTRY: true</span></span>
<span class="line"><span># [.]添加信任的私有仓库</span></span>
<span class="line"><span># 必须按照如下示例格式，协议头&#39;http://&#39;和&#39;https://&#39;不能省略</span></span>
<span class="line"><span>INSECURE_REG:</span></span>
<span class="line"><span>- &quot;http://easzlab.io.local:5000&quot;</span></span>
<span class="line"><span>- &quot;https://harbor.myserver.com&quot;</span></span>
<span class="line"><span># [.]基础容器镜像,此处使用你自己的域名替换&quot;yourdomainname&quot;</span></span>
<span class="line"><span>SANDBOX_IMAGE: &quot;harbor.yourdomainname/baseimages/pause:3.10&quot;</span></span>
<span class="line"><span># [containerd]容器持久化存储目录</span></span>
<span class="line"><span>CONTAINERD_STORAGE_DIR: &quot;/var/lib/containerd&quot;</span></span>
<span class="line"><span># [docker]容器存储目录</span></span>
<span class="line"><span>DOCKER_STORAGE_DIR: &quot;/var/lib/docker&quot;</span></span>
<span class="line"><span># [docker]开启Restful API</span></span>
<span class="line"><span>DOCKER_ENABLE_REMOTE_API: false</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:kube-master</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># k8s 集群 master 节点证书配置，可以添加多个ip和域名（比如增加公网ip和域名），后期修改可能比较麻烦，建议把将来可能会用到的IP、域名都写上。</span></span>
<span class="line"><span>MASTER_CERT_HOSTS:</span></span>
<span class="line"><span>- &quot;172.31.7.188&quot;</span></span>
<span class="line"><span>- &quot;k8s-api.yourdomainname&quot;&quot;</span></span>
<span class="line"><span>- &quot;k8s-api.myserver.com&quot;</span></span>
<span class="line"><span>#- &quot;www.test.com&quot;</span></span>
<span class="line"><span># node 节点上 pod 网段掩码长度（决定每个节点最多能分配的pod ip地址）</span></span>
<span class="line"><span># 如果flannel 使用 --kube-subnet-mgr 参数，那么它将读取该设置为每个节点分配pod网段</span></span>
<span class="line"><span># https://github.com/coreos/flannel/issues/847</span></span>
<span class="line"><span>NODE_CIDR_LEN: 24</span></span>
<span class="line"><span># 是否启用集群audit功能</span></span>
<span class="line"><span>ENABLE_CLUSTER_AUDIT: true</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:kube-node</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># Kubelet 根目录</span></span>
<span class="line"><span>KUBELET_ROOT_DIR: &quot;/var/lib/kubelet&quot;</span></span>
<span class="line"><span># node节点最大pod 数</span></span>
<span class="line"><span>MAX_PODS: 110</span></span>
<span class="line"><span># 配置为kube组件（kubelet,kube-proxy,dockerd等）预留的资源量</span></span>
<span class="line"><span># 数值设置详见templates/kubelet-config.yaml.j2</span></span>
<span class="line"><span>KUBE_RESERVED_ENABLED: &quot;no&quot;</span></span>
<span class="line"><span># k8s 官方不建议草率开启 system-reserved, 除非你基于长期监控，了解系统的资源占用状况；</span></span>
<span class="line"><span># 并且随着系统运行时间，需要适当增加资源预留，数值设置详见templates/kubelet-config.yaml.j2</span></span>
<span class="line"><span># 系统预留设置基于 4c/8g 虚机，最小化安装系统服务，如果使用高性能物理机可以适当增加预留</span></span>
<span class="line"><span># 另外，集群安装时候apiserver等资源占用会短时较大，建议至少预留1g内存</span></span>
<span class="line"><span>SYS_RESERVED_ENABLED: &quot;no&quot;</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:network [flannel,calico,cilium,kube-ovn,kube-router]</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># ------------------------------------------- flannel</span></span>
<span class="line"><span># [flannel]设置flannel 后端&quot;host-gw&quot;,&quot;vxlan&quot;等</span></span>
<span class="line"><span>FLANNEL_BACKEND: &quot;vxlan&quot;</span></span>
<span class="line"><span>DIRECT_ROUTING: false</span></span>
<span class="line"><span># [flannel]</span></span>
<span class="line"><span>flannel_ver: &quot;v0.27.3&quot;</span></span>
<span class="line"><span># ------------------------------------------- calico</span></span>
<span class="line"><span># 模式可选项有: [Always, CrossSubnet, Never],跨子网可以配置为Always与CrossSubnet</span></span>
<span class="line"><span># CrossSubnet为隧道+BGP路由混合模式可以提升网络性能，同子网配置为Never即可.</span></span>
<span class="line"><span># 公有云建议使用always比较省事，其他的话需要修改各自公有云的网络配置，具体可以参考各个公有云说明</span></span>
<span class="line"><span>CALICO_ENABLE_OVERLAY: &quot;Always&quot;</span></span>
<span class="line"><span># [calico]设置 calico-node使用的host IP，bgp邻居通过该地址建立，可手工指定也可以自动发现</span></span>
<span class="line"><span>IP_AUTODETECTION_METHOD: &quot;can-reach={{ groups[&#39;kube_master&#39;][0] }}&quot;</span></span>
<span class="line"><span># [calico]设置calico 网络 backend: bird, vxlan, none</span></span>
<span class="line"><span># 少数公有云（Azure）或者私有云不支持IPinIP封包，可以使用 vxlan 模式</span></span>
<span class="line"><span>CALICO_NETWORKING_BACKEND: &quot;bird&quot;</span></span>
<span class="line"><span># [calico]设置calico 是否使用route reflectors</span></span>
<span class="line"><span># 如果集群规模超过50个节点，建议启用该特性</span></span>
<span class="line"><span>CALICO_RR_ENABLED: false</span></span>
<span class="line"><span># CALICO_RR_NODES 配置route reflectors的节点，如果未设置默认使用集群master节点</span></span>
<span class="line"><span># CALICO_RR_NODES: [&quot;192.168.1.1&quot;, &quot;192.168.1.2&quot;]</span></span>
<span class="line"><span>CALICO_RR_NODES: []</span></span>
<span class="line"><span># [calico]更新支持calico 版本: [&quot;3.19&quot;, &quot;3.23&quot;]</span></span>
<span class="line"><span>calico_ver: &quot;v3.28.4&quot;</span></span>
<span class="line"><span># [calico]calico 主版本</span></span>
<span class="line"><span>calico_ver_main: &quot;{{ calico_ver.split(&#39;.&#39;)[0] }}.{{ calico_ver.split(&#39;.&#39;)[1] }}&quot;</span></span>
<span class="line"><span># ------------------------------------------- cilium</span></span>
<span class="line"><span># [cilium]镜像版本</span></span>
<span class="line"><span>cilium_ver: &quot;1.17.4&quot;</span></span>
<span class="line"><span>cilium_connectivity_check: false</span></span>
<span class="line"><span>cilium_hubble_enabled: false</span></span>
<span class="line"><span>cilium_hubble_ui_enabled: false</span></span>
<span class="line"><span># ------------------------------------------- kube-ovn</span></span>
<span class="line"><span># [kube-ovn]离线镜像tar包</span></span>
<span class="line"><span>kube_ovn_ver: &quot;v1.11.5&quot;</span></span>
<span class="line"><span># ------------------------------------------- kube-router</span></span>
<span class="line"><span># [kube-router]公有云上存在限制，一般需要始终开启 ipinip；自有环境可以设置为 &quot;subnet&quot;</span></span>
<span class="line"><span>OVERLAY_TYPE: &quot;full&quot;</span></span>
<span class="line"><span># [kube-router]NetworkPolicy 支持开关</span></span>
<span class="line"><span>FIREWALL_ENABLE: true</span></span>
<span class="line"><span># [kube-router]kube-router 镜像版本</span></span>
<span class="line"><span>kube_router_ver: &quot;v1.5.4&quot;</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:cluster-addon</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># coredns 自动安装</span></span>
<span class="line"><span>dns_install: &quot;no&quot;</span></span>
<span class="line"><span>corednsVer: &quot;1.12.4&quot;</span></span>
<span class="line"><span>ENABLE_LOCAL_DNS_CACHE: false</span></span>
<span class="line"><span>dnsNodeCacheVer: &quot;1.26.4&quot;</span></span>
<span class="line"><span># 设置 local dns cache 地址</span></span>
<span class="line"><span>LOCAL_DNS_CACHE: &quot;169.254.20.10&quot;</span></span>
<span class="line"><span># metric server 自动安装</span></span>
<span class="line"><span>metricsserver_install: &quot;no&quot;</span></span>
<span class="line"><span>metricsVer: &quot;v0.8.0&quot;</span></span>
<span class="line"><span># dashboard 自动安装</span></span>
<span class="line"><span>dashboard_install: &quot;no&quot;</span></span>
<span class="line"><span>dashboardVer: &quot;7.12.0&quot;</span></span>
<span class="line"><span># local-storage (local-path-provisioner) 自动安装</span></span>
<span class="line"><span>local_path_provisioner_install: &quot;no&quot;</span></span>
<span class="line"><span>local_path_provisioner_ver: &quot;v0.0.31&quot;</span></span>
<span class="line"><span>local_path_storage_class: &quot;local-path&quot;</span></span>
<span class="line"><span># 设置默认本地存储路径</span></span>
<span class="line"><span>local_path_provisioner_dir: &quot;/opt/local-path-provisioner&quot;</span></span>
<span class="line"><span># nfs-provisioner 自动安装</span></span>
<span class="line"><span>nfs_provisioner_install: &quot;no&quot;</span></span>
<span class="line"><span>nfs_provisioner_namespace: &quot;kube-system&quot;</span></span>
<span class="line"><span>nfs_provisioner_ver: &quot;v4.0.2&quot;</span></span>
<span class="line"><span>nfs_storage_class: &quot;managed-nfs-storage&quot;</span></span>
<span class="line"><span>nfs_server: &quot;192.168.1.10&quot;</span></span>
<span class="line"><span>nfs_path: &quot;/data/nfs&quot;</span></span>
<span class="line"><span># openebs 自动安装</span></span>
<span class="line"><span>openebs_install: &quot;no&quot;</span></span>
<span class="line"><span>openebs_ver: &quot;4.3.2&quot;</span></span>
<span class="line"><span>openebs_namespace: &quot;openebs&quot;</span></span>
<span class="line"><span>openebs_hostpath: &quot;/var/openebs/local&quot;</span></span>
<span class="line"><span>openebs_hostpath_storage_class: &quot;openebs-hostpath&quot;</span></span>
<span class="line"><span>openebs_lvm_storage_class: &quot;openebs-lvmpv&quot;</span></span>
<span class="line"><span>openebs_lvm_vg: &quot;vg_k8s&quot;</span></span>
<span class="line"><span># prometheus 自动安装</span></span>
<span class="line"><span>prom_install: &quot;no&quot;</span></span>
<span class="line"><span>prom_namespace: &quot;monitor&quot;</span></span>
<span class="line"><span>prom_storage_class: &quot;&quot;</span></span>
<span class="line"><span>prom_chart_ver: &quot;75.7.0&quot;</span></span>
<span class="line"><span># minio 自动安装</span></span>
<span class="line"><span>minio_install: &quot;no&quot;</span></span>
<span class="line"><span>minio_namespace: &quot;minio&quot;</span></span>
<span class="line"><span>minio_storage_class: &quot;{{ openebs_lvm_storage_class }}&quot;</span></span>
<span class="line"><span>minio_chart_ver: &quot;7.1.1&quot;</span></span>
<span class="line"><span>minio_root_user: &quot;3aea61ca94177dx&quot;</span></span>
<span class="line"><span>minio_root_password: &quot;0f3b19e46dd3aea61ca94177d&quot;</span></span>
<span class="line"><span># 单机版=1，集群版=4以上</span></span>
<span class="line"><span>minio_pool_servers: 4</span></span>
<span class="line"><span>minio_pool_size: 10Gi</span></span>
<span class="line"><span># 是否启用tls证书，如果未启用则使用http协议</span></span>
<span class="line"><span>minio_tls_enabled: false</span></span>
<span class="line"><span># 是否使用权威证书，如果使用需要提前把证书放到目录 roles/cluster-addon/templates/minio/; 并且要求</span></span>
<span class="line"><span># 证书和私钥的名称分别为server.crt和server.key</span></span>
<span class="line"><span>minio_with_global_cert: false</span></span>
<span class="line"><span># kubeapps 自动安装</span></span>
<span class="line"><span>kubeapps_install: &quot;no&quot;</span></span>
<span class="line"><span>kubeapps_install_namespace: &quot;kubeapps&quot;</span></span>
<span class="line"><span>kubeapps_working_namespace: &quot;default&quot;</span></span>
<span class="line"><span>kubeapps_storage_class: &quot;{{ openebs_hostpath_storage_class }}&quot;</span></span>
<span class="line"><span>kubeapps_chart_ver: &quot;12.4.3&quot;</span></span>
<span class="line"><span># nacos 自动安装</span></span>
<span class="line"><span>nacos_install: &quot;no&quot;</span></span>
<span class="line"><span>nacos_namespace: &quot;nacos&quot;</span></span>
<span class="line"><span>nacos_mysql_host: &quot;semisync-mysql-cluster-mysql&quot;</span></span>
<span class="line"><span>nacos_mysql_db: &quot;nacos&quot;</span></span>
<span class="line"><span>nacos_mysql_port: &quot;3306&quot;</span></span>
<span class="line"><span>nacos_mysql_user: &quot;__dbuser__&quot;</span></span>
<span class="line"><span>nacos_mysql_password: &quot;__yourpassword__&quot;</span></span>
<span class="line"><span>nacos_storage_class: &quot;{{ openebs_lvm_storage_class }}&quot;</span></span>
<span class="line"><span># rocketmq 自动安装</span></span>
<span class="line"><span>rocketmq_install: &quot;no&quot;</span></span>
<span class="line"><span>rocketmq_namespace: &quot;rocketmq&quot;</span></span>
<span class="line"><span>rocketmq_storage_class: &quot;{{ openebs_lvm_storage_class }}&quot;</span></span>
<span class="line"><span># network-check 自动安装</span></span>
<span class="line"><span>network_check_enabled: false</span></span>
<span class="line"><span>network_check_schedule: &quot;*/5 * * * *&quot;</span></span>
<span class="line"><span># kubeblocks 自动安装</span></span>
<span class="line"><span>kubeblocks_ver: &quot;1.0.0&quot;</span></span>
<span class="line"><span>kubeblocks_install: &quot;no&quot;</span></span>
<span class="line"><span># ingress-nginx 自动安装</span></span>
<span class="line"><span># ingress-nginx 只会部署到node with 标签：ingress-controller/provider=ingress-nginx</span></span>
<span class="line"><span>ingress_nginx_install: &quot;no&quot;</span></span>
<span class="line"><span>ingress_nginx_namespace: &quot;ingress-nginx&quot;</span></span>
<span class="line"><span>ingress_nginx_ver: &quot;4.13.0&quot;</span></span>
<span class="line"><span>ingress_nginx_metrics_enabled: true</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># role:harbor</span></span>
<span class="line"><span>############################</span></span>
<span class="line"><span># harbor version，完整版本号</span></span>
<span class="line"><span>HARBOR_VER: &quot;v2.12.4&quot;</span></span>
<span class="line"><span>HARBOR_DOMAIN: &quot;harbor.easzlab.io.local&quot;</span></span>
<span class="line"><span>HARBOR_PATH: /var/data</span></span>
<span class="line"><span>HARBOR_TLS_PORT: 8443</span></span>
<span class="line"><span>HARBOR_REGISTRY: &quot;{{ HARBOR_DOMAIN }}:{{ HARBOR_TLS_PORT }}&quot;</span></span>
<span class="line"><span># if set &#39;false&#39;, you need to put certs named harbor.pem and harbor-key.pem in directory</span></span>
<span class="line"><span>&#39;down&#39;</span></span>
<span class="line"><span>HARBOR_SELF_SIGNED_CERT: true</span></span>
<span class="line"><span># install extra component</span></span>
<span class="line"><span>HARBOR_WITH_TRIVY: false</span></span></code></pre></div><h3 id="_1-6-4-部署k8s集群" tabindex="-1">1.6.4 部署k8s集群 <a class="header-anchor" href="#_1-6-4-部署k8s集群" aria-label="Permalink to &quot;1.6.4 部署k8s集群&quot;">​</a></h3><p>通过ansible脚本初始化环境及部署k8s 高可用集群</p><h4 id="_1-6-4-1-环境初始化" tabindex="-1">1.6.4.1 环境初始化 <a class="header-anchor" href="#_1-6-4-1-环境初始化" aria-label="Permalink to &quot;1.6.4.1 环境初始化&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:/etc/kubeasz# vim playbooks/01.prepare.yml #系统基础初始化主机配置</span></span>
<span class="line"><span># [optional] to synchronize system time of nodes with &#39;chrony&#39;</span></span>
<span class="line"><span>- hosts:</span></span>
<span class="line"><span>- kube_master</span></span>
<span class="line"><span>- kube_node</span></span>
<span class="line"><span>- etcd</span></span>
<span class="line"><span>#- ex_lb</span></span>
<span class="line"><span>#- chrony</span></span>
<span class="line"><span>roles:</span></span>
<span class="line"><span>- { role: os-harden, when: &quot;OS_HARDEN|bool&quot; }</span></span>
<span class="line"><span>- { role: chrony, when: &quot;groups[&#39;chrony&#39;]|length &gt; 0&quot; }</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# vim roles/prepare/tasks/main.yml #禁止修改主机名，v3.6.2加入,删除60行以后的配置</span></span>
<span class="line"><span>root@k8s-deploy:/etc/kubeasz# ./ezctl setup k8s-cluster1 01 #准备CA和基础环境初始化</span></span></code></pre></div><h4 id="_1-6-4-2-部署etcd" tabindex="-1">1.6.4.2 部署etcd <a class="header-anchor" href="#_1-6-4-2-部署etcd" aria-label="Permalink to &quot;1.6.4.2 部署etcd&quot;">​</a></h4><p>可更改启动脚本路径及版本等自定义配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@k8s-deploy:/etc/kubeasz# ./ezctl setup k8s-cluster1 02 #部署</span></span>
<span class="line"><span>etcd集群</span></span></code></pre></div><p>各etcd服务器验证etcd服务：（此处以三台etcd服务器为例，如果没有这么多etcd服务器，请删除下方etcd节点IP列表多余的IP）</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>root@etcd1:~# export NODE_IPS=&quot;172.31.7.106 172.31.7.107 172.31.7.108&quot;</span></span>
<span class="line"><span>root@k8s-etcd1:~# for ip in ${NODE_IPS}; do /usr/local/bin/etcdctl --</span></span>
<span class="line"><span>endpoints=https://${ip}:2379 --cacert=/etc/kubernetes/ssl/ca.pem --</span></span>
<span class="line"><span>cert=/etc/kubernetes/ssl/etcd.pem --key=/etc/kubernetes/ssl/etcd-key.pem endpoint</span></span>
<span class="line"><span>health; done</span></span>
<span class="line"><span>https://172.31.7.106:2379 is healthy: successfully committed proposal: took = 7.742781ms</span></span>
<span class="line"><span>https://172.31.7.107:2379 is healthy: successfully committed proposal: took = 9.419607ms</span></span>
<span class="line"><span>https://172.31.7.108:2379 is healthy: successfully committed proposal: took = 9.150312ms</span></span>
<span class="line"><span>注：以上返回信息表示etcd集群运行正常，否则异常。</span></span></code></pre></div><h4 id="_1-6-4-3-部署容器运行时containerd" tabindex="-1">1.6.4.3 部署容器运行时containerd <a class="header-anchor" href="#_1-6-4-3-部署容器运行时containerd" aria-label="Permalink to &quot;1.6.4.3 部署容器运行时containerd&quot;">​</a></h4><p>由证书签发机构签发的证书可被信任,不需要执行分发步骤。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 配置nerdctl客户端:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xvf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl-2.1.6-linux-amd64.tar.gz</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/kubeasz/bin/containerd-bin/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nerdctl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">containerd-rootless-setuptool.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">containerd-rootless.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/containerd/tasks/main.yml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 准备containerd相关目录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">file:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name={{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> item</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state=directory</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with_items:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;{{ bin_dir }}/containerd-bin&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/containerd&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/containerd/certs.d/docker.io&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/containerd/certs.d/easzlab.io.local:5000&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/containerd/certs.d/{{ HARBOR_REGISTRY }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/nerdctl/&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #创建nerdctl配置文件目录</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 加载内核模块</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> overlay</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modprobe:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name=overlay</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> state=present</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 下载</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 二进制文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src={{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> item</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest={{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bin_dir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}/containerd-bin/</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0755</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">with_fileglob:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;{{ base_dir }}/bin/containerd-bin/*&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 下载</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crictl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src={{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> base_dir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}/bin/crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest={{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bin_dir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}/crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0755</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 添加</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 自动补全</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lineinfile:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dest:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.bashrc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">state:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> present</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">regexp:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;crictl completion&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">line:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;source &lt;(crictl completion bash) # generated by kubeasz&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 创建</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=config.toml.j2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/containerd/config.toml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 创建</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=nerdctl.toml.j2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/nerdctl/nerdctl.toml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #添加分发nerdctl配置文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 添加域名解析</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shell:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;echo &#39;172.31.7.104 harbor.yourdomainname&#39; &gt;&gt; /etc/hosts&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #如果需要,可添加自定义域</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">名解析</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置docker.io</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 加速镜像</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=docker.io/hosts.toml.j2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/containerd/certs.d/docker.io/hosts.toml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置local_registry</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 仓库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=&quot;easzlab.io.local:5000/hosts.toml.j2&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/etc/containerd/certs.d/easzlab.io.local:5000/hosts.toml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置harbor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 仓库</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=&quot;HARBOR_REGISTRY/hosts.toml.j2&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/containerd/certs.d/{{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HARBOR_REGISTRY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}/hosts.toml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 创建systemd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unit文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=containerd.service.j2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/systemd/system/containerd.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 创建</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">template:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> src=crictl.yaml.j2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dest=/etc/crictl.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 开机启用</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shell:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ignore_errors:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 开启</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 服务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shell:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> daemon-reload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 轮询等待containerd服务运行</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shell:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;systemctl is-active containerd.service&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">register:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd_status</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">until: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&quot;active&quot; in containerd_status.stdout&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">retries:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delay:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tags:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> upgrade</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># nerdctl配置文件：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/containerd/templates/nerdctl.toml.j2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namespace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;k8s.io&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug_full</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insecure_registry</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可选自定义containerd service文件：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/containerd/templates/containerd.service.j2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Description</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">containerd</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> container</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> runtime</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Documentation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://containerd.io</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">After</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">network.target</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Environment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PATH={{ bin_dir }}/containerd-bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecStartPre</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">-/sbin/modprobe</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> overlay</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ExecStart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{{ bin_dir }}/containerd-bin/containerd --log-level warn</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Restart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">always</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RestartSec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">5</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Delegate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KillMode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">process</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">OOMScoreAdjust</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">-999</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LimitNOFILE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1048576</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Having non-zero Limit*s causes performance problems due to accounting overhead</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the kernel. We recommend using cgroups to do container-local accounting.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LimitNPROC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">infinity</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LimitCORE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">infinity</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WantedBy</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 执行部署运行时：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k8s-cluster1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 03</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/containerd-bin/containerd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> github.com/containerd/containerd/v2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v2.1.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">75cb2b7193e4e490e9fbdc236c0e811ccaba3376</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -sv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/containerd-bin/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/local/bin/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Client:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Version:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v2.1.6</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">OS/Arch:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linux/amd64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> commit:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 59253e9931873e79b92fe3400f14e69d6be34025</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">buildctl:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Version:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Server:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">containerd:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Version:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v2.1.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GitCommit:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 75cb2b7193e4e490e9fbdc236c0e811ccaba3376</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runc:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Version:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.3.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GitCommit:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.3.1-0-ge6457afc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#验证可以登录harbor，用于后期镜像分发：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomianname</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Enter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Username:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Enter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Password:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WARN[0003]</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> skipping</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> verifying</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> HTTPS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;harbor.myarchitect.online:443&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WARNING!</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Your</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> credentials</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> are</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stored</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> unencrypted</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/root/.docker/config.json&#39;.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Configure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> credential</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> helper</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> remove</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> warning.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> See</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://docs.docker.com/go/credential-store/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Login</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Succeeded</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#测试上传镜像</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/zhangshijie/ubuntu:22.04</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/zhangshijie/ubuntu:22.04</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomainname/baseimages/ubuntu:22.04</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/ubuntu:22.04</span></span></code></pre></div><h4 id="_1-6-4-4-部署kubernetes-master节点" tabindex="-1">1.6.4.4 部署kubernetes master节点 <a class="header-anchor" href="#_1-6-4-4-部署kubernetes-master节点" aria-label="Permalink to &quot;1.6.4.4 部署kubernetes master节点&quot;">​</a></h4><p>根据实际业务需求可选择性更改启动脚本参数及路径等自定义功能</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> help</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/kube-master/tasks/main.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #可自定义配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k8s-cluster1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 04</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.101</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7m55s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.102</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7m55s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span></code></pre></div><h4 id="_1-6-4-5-部署kubernetes-node节点" tabindex="-1">1.6.4.5 部署kubernetes node节点 <a class="header-anchor" href="#_1-6-4-5-部署kubernetes-node节点" aria-label="Permalink to &quot;1.6.4.5 部署kubernetes node节点&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> help</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/kube-node/tasks/main.yml</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #可自定义配置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k8s-cluster1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 05</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ROLES</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> VERSION</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.101</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 12m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.102</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready,SchedulingDisabled</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> master</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 12m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.111</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 24s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">172.31.7.112</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Ready</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 24s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v1.34.1</span></span></code></pre></div><h4 id="_1-6-4-6-部署网络组件calico" tabindex="-1">1.6.4.6 部署网络组件calico <a class="header-anchor" href="#_1-6-4-6-部署网络组件calico" aria-label="Permalink to &quot;1.6.4.6 部署网络组件calico&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz/roles/calico/templates#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pwd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/kubeasz/roles/calico/templates</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz/roles/calico/templates#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico_v3.28.4-k8s_1.34.1-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ubuntu2404.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./calico-v3.28.yaml.j2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz/roles/calico/templates#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/kubeasz/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clusters/k8s-cluster1/config.yml</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># [calico]更新支持calico 版本: [&quot;3.19&quot;, &quot;3.23&quot;]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">calico_ver:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;v3.28.4&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #指定自己的版本</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># [calico]calico 主版本 # [calico]calico 获取主版本传递给部署任务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">calico_ver_main:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;{{ calico_ver.split(&#39;.&#39;)[0] }}.{{ calico_ver.split(&#39;.&#39;)[1] }}&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">查看calico镜像：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;image:&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/calico/templates/calico-v3.28.yaml.j2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> easzlab.io.local:5000/calico/cni:{{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico_ver</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> easzlab.io.local:5000/calico/node:{{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico_ver</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> easzlab.io.local:5000/calico/node:{{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico_ver</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> easzlab.io.local:5000/calico/kube-controllers:{{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico_ver</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> }}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">将镜像上传至本地harbor：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico/node:v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomainname/baseimages/calico-node:v3.26.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/caliconode:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico/kube-controllers:v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomainname/baseimages/calico-kube-controllers:v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/calico-kubecontrollers:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico/cni:v3.26.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomainname/baseimages/cni:v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.yourdomainname/baseimages/cni:v3.28.4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">修改yaml文件中的镜像地址：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/calico/templates/calico-v3.26.yaml.j2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;image:&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> roles/calico/templates/calico-v3.26.yaml.j2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#image: docker.io/calico/cni:v3.28.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/calico:cni-v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#image: docker.io/calico/cni:v3.28.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/calico:cni-v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#image: docker.io/calico/node:v3.28.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/calico:node-v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#image: docker.io/calico/node:v3.28.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/calico:node-v3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#image: docker.io/calico/kube-controllers:v3.28.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">image:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> registry.cn-hangzhou.aliyuncs.com/myhubregistry/calico:kube-controllersv3.28.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:/etc/kubeasz#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./ezctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> k8s-cluster1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 06</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -A</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #calico 初始化过程中</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico-kube-controllers-695bf6cc9d-vb5tl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2m28s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico-node-q2xzs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Init:2/3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2m28s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico-node-vf7xp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2m28s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico-node-vtzmz</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Init:2/3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2m28s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calico-node-vwng2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Init:2/3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2m28s</span></span></code></pre></div><p>验证calico</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calicoctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Calico</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> running.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IPv4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BGP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PEER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ADDRESS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PEER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> STATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SINCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> INFO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.102</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:26</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.111</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:26</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.112</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:26</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IPv6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BGP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IPv6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> peers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> found.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-node1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> calicoctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Calico</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> running.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IPv4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BGP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PEER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ADDRESS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PEER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> STATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SINCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> INFO</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.102</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:12</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.112</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 172.31.7.101</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> node-to-node</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mesh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> up</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> 08:18:25</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Established</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+--------------+-------------------+-------+----------+-------------+</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">IPv6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BGP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">No</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IPv6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> peers</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> found.</span></span></code></pre></div><h4 id="_1-6-4-7-验证pod通信" tabindex="-1">1.6.4.7 验证pod通信 <a class="header-anchor" href="#_1-6-4-7-验证pod通信" aria-label="Permalink to &quot;1.6.4.7 验证pod通信&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> net-test1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --image=registry.cnhangzhou.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aliyuncs.com/zhangshijie/alpine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 360000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/net-test1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> net-test2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --image=registry.cnhangzhou.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aliyuncs.com/zhangshijie/alpine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 360000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/net-test2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> net-test3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --image=registry.cnhangzhou.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">aliyuncs.com/zhangshijie/alpine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 360000</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod/net-test3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> created</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wide</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #验证pod的跨主机通信</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> READY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STATUS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RESTARTS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> AGE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NODE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NOMINATED</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NODE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">READINESS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GATES</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net-test1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 35s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.200.165.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.31.7.112</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">none</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net-test2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 30s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.200.45.1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.31.7.111</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">none</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net-test3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1/1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Running</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 26s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.200.165.2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 172.31.7.112</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">none</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-deploy:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> net-test1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # ping 10.200.45.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PING</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.200.45.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (10.200.45.1): 56 data bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.754</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.546</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.566</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.517</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.650</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.589</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 10.200.45.1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> seq=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ttl=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">62</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> time=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.645</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ms</span></span></code></pre></div><h4 id="_1-6-4-8-查看集群控制器leader信息" tabindex="-1">1.6.4.8 查看集群控制器leader信息 <a class="header-anchor" href="#_1-6-4-8-查看集群控制器leader信息" aria-label="Permalink to &quot;1.6.4.8 查看集群控制器leader信息&quot;">​</a></h4><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ubuntu@deploy01:~$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> leases</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-system</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                   HOLDER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                                                      AGE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apiserver-x3wkiompg56yjadueu4vtmjide</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   apiserver-x3wkiompg56yjadueu4vtmjide_07de2ec0-34bc-4feb-a2ff-4f953d2d8a3b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   38h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-controller-manager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                172.31.7.101_ea6d8067-e59d-446f-86ee-307ed4cd15c5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                           38h</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-scheduler</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                         172.31.7.101_9bab903a-b5d8-4f58-8c09-ef922c6f7158</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                           38h</span></span></code></pre></div><h2 id="_1-7-部署coredns" tabindex="-1">1.7 部署CoreDNS <a class="header-anchor" href="#_1-7-部署coredns" aria-label="Permalink to &quot;1.7 部署CoreDNS&quot;">​</a></h2><p>目前常用的dns组件有kube-dns和coredns，用于解析k8s集群中service name所对应得到IP地址，从kubernetes v1.18开始不支持使用kube-dns。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">k8s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.18版本以后将不再支持kube-dns。</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.18.md#downloadsfor-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v1180</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubeadm:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kube-dns</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deprecated</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> will</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> not</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> supported</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> future</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> version</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">skyDNS/kube-dns/coreDNS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kube-dns：提供service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> name域名的解析</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dns-dnsmasq：提供DNS缓存，降低kubedns负载，提高性能</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dns-sidecar：定期检查kubedns和dnsmasq的健康状态</span></span></code></pre></div><h3 id="_1-7-1-部署coredns" tabindex="-1">1.7.1 部署coredns <a class="header-anchor" href="#_1-7-1-部署coredns" aria-label="Permalink to &quot;1.7.1 部署coredns&quot;">​</a></h3><p>参考：</p><p><a href="https://github.com/coredns/coredns" target="_blank" rel="noreferrer">https://github.com/coredns/coredns</a></p><p><a href="https://coredns.io/" target="_blank" rel="noreferrer">https://coredns.io/</a></p><p><a href="https://github.com/coredns/deployment/tree/master/kubernetes" target="_blank" rel="noreferrer">https://github.com/coredns/deployment/tree/master/kubernetes</a></p><h2 id="_1-8-部署可视化web管理界面" tabindex="-1">1.8 部署可视化web管理界面 <a class="header-anchor" href="#_1-8-部署可视化web管理界面" aria-label="Permalink to &quot;1.8 部署可视化web管理界面&quot;">​</a></h2><p>部署kubernetes的web管理界面dashboard</p><h3 id="_1-8-1-kubernetes-官方dashboard" tabindex="-1">1.8.1 kubernetes 官方dashboard <a class="header-anchor" href="#_1-8-1-kubernetes-官方dashboard" aria-label="Permalink to &quot;1.8.1 kubernetes 官方dashboard&quot;">​</a></h3><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dashboard-v2.7.0.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetesui/metrics-scraper:v1.0.8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetesui/metrics-scraper:v1.0.8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.myarchitect.online/baseimages/metrics-scraper:v1.0.8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> harbor.myarchitect.online/baseimages/metricsscraper:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v1.0.8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetesui/dashboard:v2.7.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tag</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetesui/dashboard:v2.7.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomianname/baseimages/kubernetesui/dashboard:v2.7.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nerdctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">harbor.yourdomianname/baseimages/kubernetesui/dashboard:v2.7.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dashboard-v2.7.0.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dashboard-v2.7.0.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin-user.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> adminsecret.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:/etc/kubeasz/2.dashboard-v2.7.0#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> describe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secrets</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetesdashboard</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dashboard-admin-user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dashboard-admin-user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Namespace:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetes-dashboard</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Labels:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">non</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Annotations:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetes.io/service-account.name:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin-user</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubernetes.io/service-account.uid:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f25bd543-dedb-4d61-aa2d-749f3a1e63d9</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubernetes.io/service-account-token</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Data</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">====</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ca.crt:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1310</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namespace:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">token:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eyJhbGciOiJSUzI1NiIsImtpZCI6IlltRGNDc2VMYkdXa19NMU0zLWhrN0ZYWDltMkxUTHVIdXNlY3RMRkJZV2MifQ.e</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hb</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WUiOiJkYXNoYm9hcmQtYWRtaW4tdXNlciIsImt1YmVybmV0ZuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kIjoiZjI1YmQ1NDMtZGVkYi00ZDYxLWFhMmQtNzQ5ZjNhMWU2M2Q5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmFkbWluLXVzZXIifQ.lkwLyxWPP3tI9osh3r4JyOaAtEBBd52yqiB1pg-Kbei-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TePFG48SEE0BkPUiymp16Nd7Ckc5939PQRN2LAhFuSoNDm88TpmNO13jq_GTKol3Wpamw5yK83_qOiH1_NkBe-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">F4VQTxWglmboMV3b6ny02Dx5FtBVnn95m959KhROErZKijJQSP0c1JTeXmKds5L4_J7T7NPrt2_wFKiphwrubBTM1d_8</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">19zD0avYopTHx1OEXdkAJJM_BMiykhxtxj29lpd2ElQTE0_chOBuYLlsvw2UitKUEU8phw58-</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6bLZbH3Xgj8fWPQ9cDCeEPWnF7saP-RzYBB4M-9ST--ARlw</span></span></code></pre></div><p>复制token后可登录WEB页面进行测试</p><h3 id="_1-8-3-kuboard" tabindex="-1">1.8.3 kuboard <a class="header-anchor" href="#_1-8-3-kuboard" aria-label="Permalink to &quot;1.8.3 kuboard&quot;">​</a></h3><p>官方的dashboard并不太好用，可以考虑部署kuboard</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#在kubernetes环境部署kuboard：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-ha1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nfs-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-ha1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/k8sdata/kuboard</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-ha1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/exports</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/data/k8sdata/kuboard</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rw,no_root_squash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-ha1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nfs-server.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-ha1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nfs-server.service</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 部署方式1：kubernetes部署：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kuboard#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kuboard-all-in-one.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">在浏览器输入</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://your-host-ip:30080</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 即可访问</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Kuboard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3.x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 的界面，登录方式：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">用户名：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">密</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 码：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Kuboard123</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#d 部署方式2：ocker单机</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@k8s-master1:~#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--restart=unless-stopped </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">--name=kuboard </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-p </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">80:80/tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-p </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10081:10081/tcp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KUBOARD_ENDPOINT=&quot;http://172.31.7.101:80&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-e </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">KUBOARD_AGENT_SERVER_TCP_PORT=&quot;10081&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-v </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/root/kuboard-data:/data</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">在浏览器输入</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://your-host-ip:80</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 即可访问</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Kuboard</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3.x</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 的界面，登录方式：</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">用户名：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">密</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 码：</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Kuboard123</span></span></code></pre></div><p>部署完成后可通过导入kubeconfig将集群添加到kuboard 如需卸载kuboard可执行</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kuboard#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kuboard-all-in-one.yaml</span></span></code></pre></div><p>注意：如果在虚拟机中部署、测试集群</p><p>建议的关机顺序是：node节点-&gt;master节点-&gt;etcd节点</p><p>建议的开机顺序是：etcd节点-&gt;master节点-&gt;node节点</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><!----><!----></footer><!--[--><!--[--><!--[--><div class="comment" data-v-97a23b9e><script src="https://giscus.app/client.js" data-repo="Kshaoye/kshaoye.github.io" data-repo-id="R_kgDOK9I0lg" data-category="Announcements" data-category-id="DIC_kwDOK9I0ls4Cefc1" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="zh-CN" crossorigin="anonymous" data-loading="eager" async data-v-97a23b9e></script></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"en_aboutme.md\":\"DAKsaFN4\",\"en_balance_martialarts_index.md\":\"i91WJyGQ\",\"en_balance_martialarts_taijiswordsizechart.md\":\"CySToHzF\",\"en_balance_musings_index.md\":\"BVKgwA_P\",\"en_index.md\":\"DHWNlBlb\",\"index.md\":\"DYl6wwZc\",\"private_studio.md\":\"Df-bXqfZ\",\"private_中国剑.md\":\"ndYIZhwv\",\"private_公有云集群规划.md\":\"BrKOlE2O\",\"private_实验记录.md\":\"Wy-buO8w\",\"zh_aboutme.md\":\"DlSjsID3\",\"zh_balance_index.md\":\"DEu014k_\",\"zh_balance_martialarts_index.md\":\"B5qu9RfN\",\"zh_balance_martialarts_taijiswordsizechart.md\":\"Da-Sge1R\",\"zh_balance_martialarts_wuxiansword.md\":\"DAanHnl2\",\"zh_balance_musings_index.md\":\"C3w6AMB4\",\"zh_k8s_buildcontainerimagewithnerdctlandbuildkit.md\":\"BF0Ax9eS\",\"zh_k8s_deployandmaintainnginxserviceink8scluster.md\":\"Dkj93u6D\",\"zh_k8s_deployk8sclusterwithkubeasz.md\":\"DvPXF1ja\",\"zh_k8s_etcdbackupandrestore.md\":\"Dh_6oOQu\",\"zh_k8s_index.md\":\"qHhniDVA\",\"zh_k8s_interviewquestions_index.md\":\"DWaccHdS\",\"zh_k8s_interviewquestions_procedure_of_accessing_nodeport_pods_from_load_balancer.md\":\"DLX77Qk9\",\"zh_k8s_interviewquestions_procedure_of_creating_pods.md\":\"3oAv_HXP\",\"zh_k8s_interviewquestions_what_happens_when_a_probe_fails_in_kubernetes.md\":\"w09iNlpM\",\"zh_k8s_interviewquestions_why_do_production_environments_use_pod_directly_mount_nfs.md\":\"DBecEeiG\",\"zh_k8s_k8scommandcheatsheet.md\":\"CiOWg6J6\",\"zh_k8s_k8snodescaling.md\":\"DvbfEPGz\",\"zh_k8s_k8srunjavajenkinswithpersistence.md\":\"IRB0hvdm\",\"zh_k8s_k8srunwordpresswithmysql.md\":\"Cj77hlLV\",\"zh_k8s_kubernetescorecomponents.md\":\"COfzkrL9\",\"zh_k8s_layeredbuildsystemimageandwebserviceimage.md\":\"BOwpiT42\",\"zh_k8s_nginxjavanfsseparatedarchitecture.md\":\"CzQMfO7s\",\"zh_k8s_podmountvolumes.md\":\"DnI9HBTN\",\"zh_k8s_probe.md\":\"RuFfSDed\",\"zh_k8s_statefulsetmysql.md\":\"rR8YT7n3\",\"zh_k8s_statefulsetrediscluster.md\":\"DSWEdzH1\",\"zh_k8s_statefulsetzookeeper.md\":\"492UwgYf\",\"zh_prometheus_index.md\":\"CcQWDNgm\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en\",\"dir\":\"ltr\",\"title\":\"Kevin Crimson\",\"description\":\"Navigating the digital era while rediscovering the balance between ancient Chinese wisdom and modern life.\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/alemon.jpg\",\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Kubernetes\",\"link\":\"/zh/k8s/index\"},{\"text\":\"Prometheus\",\"link\":\"/zh/Prometheus/index\"},{\"text\":\"Banlance\",\"items\":[{\"text\":\"MartialArts\",\"link\":\"/zh/balance/MartialArts/index\"},{\"text\":\"Musings\",\"link\":\"/zh/balance/Musings/index\"}]},{\"text\":\"Other\",\"items\":[{\"text\":\"About Me\",\"link\":\"/zh/AboutMe\"}]}],\"localeLinks\":{\"text\":\"Languages\",\"items\":[{\"text\":\"简体中文\",\"link\":\"/\"},{\"text\":\"English\",\"link\":\"/en/\"}]},\"i18nRouting\":false,\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"zh\":{\"translations\":{\"button\":{\"buttonText\":\"搜索\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询结果\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}},\"en\":{\"translations\":{\"button\":{\"buttonText\":\"Search\",\"buttonAriaLabel\":\"Search for Documents\"},\"modal\":{\"noResultsText\":\"Unable to find relevant results\",\"resetButtonTitle\":\"Clear Query Results\",\"footer\":{\"selectText\":\"select\",\"navigateText\":\"switch\"}}}}}}}},\"locales\":{\"zh\":{\"label\":\"简体中文\",\"lang\":\"zh-CN\",\"link\":\"/\",\"themeConfig\":{\"lastUpdatedText\":\"上次更新\",\"returnToTopLabel\":\"返回顶部\",\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"logo\":\"/img/crimson.png\",\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"Kubernetes\",\"link\":\"/zh/k8s/index\"},{\"text\":\"Prometheus\",\"link\":\"/zh/Prometheus/index\"},{\"text\":\"Banlance\",\"items\":[{\"text\":\"MartialArts\",\"link\":\"/zh/balance/MartialArts/index\"},{\"text\":\"Musings\",\"link\":\"/zh/balance/Musings/index\"}]},{\"text\":\"Other\",\"items\":[{\"text\":\"About Me\",\"link\":\"/zh/AboutMe\"}]}],\"localeLinks\":{\"text\":\"语言/Language\",\"items\":[{\"text\":\"简体中文\",\"link\":\"/\"},{\"text\":\"English\",\"link\":\"/en/\"}]},\"outline\":{\"level\":\"deep\",\"label\":\"目录\"}}},\"en\":{\"label\":\"English\",\"lang\":\"en-US\",\"link\":\"/en/\",\"themeConfig\":{\"lastUpdatedText\":\"Last Updated\",\"returnToTopLabel\":\"Return to Top\",\"docFooter\":{\"prev\":\"Previous Page\",\"next\":\"Next Page\"},\"logo\":\"/img/crimson.png\",\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"MartialArts\",\"link\":\"/en/balance/MartialArts/index\"},{\"text\":\"Musings\",\"link\":\"/en/balance/Musings/index\"},{\"text\":\"Other\",\"items\":[{\"text\":\"About Me\",\"link\":\"/AboutMe\"}]}],\"localeLinks\":{\"text\":\"语言/Language\",\"items\":[{\"text\":\"简体中文\",\"link\":\"/\"},{\"text\":\"English\",\"link\":\"/en/\"}]},\"outline\":{\"level\":\"deep\",\"label\":\"Contents\"}}}},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>